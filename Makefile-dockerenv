#! /usr/bin/make
#
# Copyright (c) 2021, Collins Aerospace.
# Developed with the sponsorship of Defense Advanced Research Projects Agency (DARPA).
#
# Permission is hereby granted, free of charge, to any person obtaining a copy of this data, 
# including any software or models in source or binary form, as well as any drawings, specifications, 
# and documentation (collectively &quot;the Data&quot;), to deal in the Data without restriction, including
# without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, 
# and/or sell copies of the Data, and to permit persons to whom the Data is furnished to do so, 
# subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all copies or 
# substantial portions of the Data.
#
# THE DATA IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT 
# LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. 
# IN NO EVENT SHALL THE AUTHORS, SPONSORS, DEVELOPERS, CONTRIBUTORS, OR COPYRIGHT HOLDERS BE LIABLE 
# FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, 
# ARISING FROM, OUT OF OR IN CONNECTION WITH THE DATA OR THE USE OR OTHER DEALINGS IN THE DATA.

# Extra vars
DOCKER_BUILD ?= docker build
DOCKER_FLAGS ?= --force-rm=true
ifndef EXEC
	EXEC := bash
	DOCKER_RUN_FLAGS += -it
endif

# Volumes
DOCKER_VOLUME_HOME ?= $(shell whoami)-home

# Interactive images
HOST_DIR ?= $(shell pwd)
USER_IMG := user_agree_build-$(shell whoami)
EXTRA_DOCKER_RUN_ARGS := -u $(shell id -u):$(shell id -g)

.PHONY: user
user: build_user user_run

.PHONY:
build_user:
	$(DOCKER_BUILD) $(DOCKER_FLAGS) \
		--build-arg=UNAME=$(shell whoami) \
		--build-arg=UID=$(shell id -u) \
		--build-arg=GID=$(shell id -g) \
		--build-arg=GROUP=$(shell id -gn) \
		-f Dockerfile \
		-t $(USER_IMG) \
		.

.PHONY: user_run
user_run:
	docker run \
		$(DOCKER_RUN_FLAGS) \
		--hostname in-container \
		--rm \
		$(EXTRA_DOCKER_RUN_ARGS) \
		--group-add sudo \
		-v $(HOST_DIR):/host:z \
		-v $(DOCKER_VOLUME_HOME):/home/$(shell whoami) \
		-v /etc/localtime:/etc/localtime:ro \
		$(USER_IMG) $(EXEC)

